---
title: | 
  | BST 6200 Spatial Statistics and Disease Mapping
  | Homework 4
author: "Miao Cai"
output:
  pdf_document: 
    number_sections: true
    #always_allow_html: true
always_allow_html: true
header-includes:
  - \usepackage{booktabs}
  - \usepackage{float}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



**Overall Goal**: Perform an ecological study of the relationship between smoking and pancreatic cancer rates in the state of Minnesota.


Homework description
====================

Obtain the shape file for Minnesota through the tigris package.

Obtain the smoking data by selecting Minnesota and Adult Smoking here:

[https://www.countyhealthrankings.org/explore-health-rankings/measures-data-sources/county-health-rankings-model/health-factors/health-behaviors/tobacco-use](https://www.countyhealthrankings.org/explore-health-rankings/measures-data-sources/county-health-rankings-model/health-factors/health-behaviors/tobacco-use)

You can probably copy the data and paste it into Excel.

Obtain the number of cases and the population size here: [https://data.web.health.state.mn.us/cancer_query](https://data.web.health.state.mn.us/cancer_query).

Use shift-click to select all counties. Then select “Pancreas” under Indicator, “2012-2016” under Year, and “All” under Sex. Then click “Submit” and finally “Download” at the bottom of the data. Two of the columns in the resulting file are “count” and “population”. You will need both of these. You might want to clean up this file using Excel.

As part of your report, give choropleth maps of smoking rates and pancreatic cancer rates. Compute Moran’s I for both and assess their significance.

Run a regression model of the form:

$$
\begin{aligned}
Y_i & \sim \text{Poisson}(P_i\eta_i)\\
\text{where}\\
\eta_i & = \exp(\beta_0 + \beta_1x_i + u_i + \nu_i)\\
P_i & = \text{population of county } i\\
u_i & \text{ is correlated heterogeneity of county }i\\
v_i & \text{ is uncorrelated heterogeity of county }i\\
x_i & \text{ is the smoking rate of county } i
\end{aligned}
$$

Write a report addressing the question of smoking and pancreatic cancer. The project shouldn’t be too long. I’m thinking something like 3 to 6 pages, counting figures.

[Note: This project is much like the term project for the course, except I have pointed you to the data and given you a specific model with just one predictor variable (smoking). You should look for more than one predictor variable in your term project model.]

Data
====

```{r}
pacman::p_load(tigris, sp, ggplot2, nimble,
               tmap, dplyr, sf, data.table, rgeos)

MN = counties("Minnesota", cb = TRUE)


adult_smoke = fread("data/Minnesota_adult_smoking.csv") %>% 
  select(FIPS, smoking_rate = `% Smokers`)
pancreas = fread("data/Minnesota_Pancreas_cancer.csv") %>% 
  select(FIPS = fips, 
         year, 
         N_pancreas = count, 
         population, 
         rate_pancreas = rate) %>% 
  mutate(rate_pancreas = gsub(" \\(UR\\)", "", rate_pancreas) %>% 
           as.numeric())

MN_sf = st_as_sf(MN) %>% 
  mutate(FIPS = as.integer(paste0(STATEFP, COUNTYFP))) %>% 
  select(NAME, FIPS) %>% 
  arrange(NAME) %>% 
  left_join(pancreas, by = 'FIPS') %>% 
  left_join(adult_smoke, by = 'FIPS')

head(MN_sf)
```

Choropleth maps
===============

```{r fig.cap='Choropleth maps of pancreas cancer rates (left) and adult smoking rates (right) in Minnesota'}
map_pancreas = tm_shape(MN_sf) +
  tm_fill(title = "Pancreas cancer\nrates",
          col = "rate_pancreas", 
          palette = "Reds") +
  tm_borders(col = "black") + 
  tm_layout(main.title = "Pancreas cancer rates in Minnesota",  
            main.title.size = 1.2, frame = FALSE) + 
  tm_legend(legend.position = c("right", "center"))

map_smoking = tm_shape(MN_sf) +
  tm_fill(title = "Adult smoking\nrates",
          col = "smoking_rate", 
          palette = "Reds") +
  tm_borders(col = "black") +
  tm_layout(main.title = "Adult smoking rates in Minnesota",  
            main.title.size = 1.2, frame = FALSE) + 
  tm_legend(legend.position = c("right", "center"))

tmap_arrange(map_pancreas, map_smoking, ncol = 2)
```

